name: splice-validator

volumes:
  postgres-splice:
  domain-upgrade-dump:
  keycloak-data:

networks:
  dserv-network:
    name: dserv-network
    driver: bridge

services:
  postgres-splice:
    image: "postgres:${SPLICE_POSTGRES_VERSION}"
    environment:
      - POSTGRES_USER=${SPLICE_DB_USER}
      - POSTGRES_PASSWORD=${SPLICE_DB_PASSWORD}
      - POSTGRES_DB=postgres # not used by splice
      # Any env vars starting with CREATE_DATABASE_ will be used to create a database
      - CREATE_DATABASE_participant=participant
      - CREATE_DATABASE_participant_user=participant-user
      - CREATE_DATABASE_participant_provider=participant-provider
      - CREATE_DATABASE_validator=validator
      - CREATE_DATABASE_validator_app_user=validator-app-user
      - CREATE_DATABASE_validator_app_provider=validator-app-provider
      - CREATE_DATABASE_keycloak=keycloak
      - CREATE_DATABASE_dserv=dserv
    # DEVELOPMENT: PostgreSQL port exposed for development access
    ports:
      - "5432:5432"
    volumes:
      - postgres-splice:/var/lib/postgresql/data
      - ./postgres-entrypoint.sh:/postgres-entrypoint.sh
    entrypoint: /postgres-entrypoint.sh
    user: "postgres"
    command:
      - postgres
      - -c
      - max_connections=8000
    healthcheck:
      test: "pg_isready -U ${SPLICE_DB_USER} -d postgres"
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 60s
    networks:
      - dserv-network

  # Keycloak authentication service
  # Note: No direct port exposure - access via nginx-keycloak proxy on port 8082
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KC_DB=postgres
      - KC_DB_URL=jdbc:postgresql://postgres-splice:5432/keycloak
      - KC_DB_USERNAME=${SPLICE_DB_USER}
      - KC_DB_PASSWORD=${SPLICE_DB_PASSWORD}
    volumes:
      - ./config/keycloak/data:/opt/keycloak/data/import
      - ./keycloak-theme:/opt/keycloak/themes
    command:
      - start-dev
      - --import-realm
      - --http-port=8082
      - --health-enabled=true
      - --hostname-strict=false
      - --proxy-headers=forwarded
    depends_on:
      postgres-splice:
        condition: service_healthy

    healthcheck:
      test:
        [
          "CMD-SHELL",
          "timeout 10 bash -c 'until echo > /dev/tcp/localhost/9000; do sleep 1; done'",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - dserv-network

  # IMPORTANT: nginx-keycloak proxy is required for proper Keycloak configuration
  # - Provides consistent port mapping (8082) for Keycloak access
  # - Handles CORS and proxy configuration for Keycloak
  # - Simplifies authentication setup for applications
  # - DO NOT REMOVE: This service is essential for the authentication flow
  nginx-keycloak:
    image: "nginx:${NGINX_VERSION}"
    container_name: nginx-keycloak
    volumes:
      - ./config/nginx-keycloak/nginx.conf:/etc/nginx/nginx.conf
      - ./config/nginx-keycloak/keycloak-local.conf:/etc/nginx/conf.d/default.conf
      - ./config/nginx-keycloak/oidc-config.json:/etc/nginx/oidc-config.json
      - /etc/letsencrypt:/etc/letsencrypt:ro
    ports:
      - "8082:8082"
      - "8083:8083"
      - "443:443"
    depends_on:
      - keycloak
    networks:
      - dserv-network

  participant:
    image: "${IMAGE_REPO}canton-participant:${IMAGE_TAG}"
    env_file:
      - ./env/ports.env
      - ./env/app-provider.env
      - ./env/app-user.env
    environment:
      - AUTH_JWKS_URL=${AUTH_JWKS_URL}
      - AUTH_TARGET_AUDIENCE=${LEDGER_API_AUTH_AUDIENCE}
      - CANTON_PARTICIPANT_ADMIN_USER_NAME=${LEDGER_API_ADMIN_USER}
      - CANTON_PARTICIPANT_POSTGRES_SERVER=${SPLICE_DB_SERVER}
      - CANTON_PARTICIPANT_POSTGRES_SCHEMA=participant
      - CANTON_PARTICIPANT_POSTGRES_USER=${SPLICE_DB_USER}
      - CANTON_PARTICIPANT_POSTGRES_PASSWORD=${SPLICE_DB_PASSWORD}
      - CANTON_PARTICIPANT_POSTGRES_DB=participant
      - CANTON_PARTICIPANT_POSTGRES_PORT=${SPLICE_DB_PORT}
      - DB_SERVER=${SPLICE_DB_SERVER}
      - DB_PORT=${SPLICE_DB_PORT}
      - DB_USER=${SPLICE_DB_USER}
      - DB_PASSWORD=${SPLICE_DB_PASSWORD}
      - LEDGER_API_ADMIN_USER=${LEDGER_API_ADMIN_USER}
      # Port variables are loaded from env/ports.env via env_file above
      # No need to set them here - env_file will make them available to the container
      # Base URLs loaded from env_file (needed for variable expansion below)
      # Use defaults if not set in host environment (env_file will override these in container)
      - AUTH_APP_USER_ISSUER_URL_BACKEND=${AUTH_APP_USER_ISSUER_URL_BACKEND:-http://nginx-keycloak:8082/realms/AppUser}
      - AUTH_APP_PROVIDER_ISSUER_URL_BACKEND=${AUTH_APP_PROVIDER_ISSUER_URL_BACKEND:-http://nginx-keycloak:8082/realms/AppProvider}
      # Expand JWK URLs dynamically using the base URLs set above
      - AUTH_APP_USER_JWK_SET_URL=${AUTH_APP_USER_ISSUER_URL_BACKEND:-http://nginx-keycloak:8082/realms/AppUser}/protocol/openid-connect/certs
      - AUTH_APP_PROVIDER_JWK_SET_URL=${AUTH_APP_PROVIDER_ISSUER_URL_BACKEND:-http://nginx-keycloak:8082/realms/AppProvider}/protocol/openid-connect/certs
      # Expand party hints dynamically from PARTY_HINT
      - APP_USER_PARTY_HINT=app_user_${PARTY_HINT}
      - APP_PROVIDER_PARTY_HINT=app_provider_${PARTY_HINT}
    volumes:
      - ./config/participant/app.conf:/app/app.conf
    ports:
      - "27575:27575"
      - "37575:37575"
      - "25001:25001"
      - "35001:35001"
      - "25002:25002"
      - "35002:35002"
      - "27000:27000"
      - "37000:37000"
      - "25061:25061"
      - "35061:35061"
    depends_on:
      postgres-splice:
        condition: service_healthy
    restart: always
    networks:
      - dserv-network

  validator:
    image: "${IMAGE_REPO}validator-app:${IMAGE_TAG}"
    env_file:
      - ./env/app-provider.env
      - ./env/app-user.env
    environment:
      # Base URLs for user realm
      - AUTH_APP_USER_ISSUER_URL_BACKEND=http://nginx-keycloak:8082/realms/AppUser
      - AUTH_APP_USER_WELLKNOWN_URL=http://nginx-keycloak:8082/realms/AppUser/.well-known/openid-configuration
      - AUTH_APP_USER_JWK_SET_URL=http://nginx-keycloak:8082/realms/AppUser/protocol/openid-connect/certs
      - AUTH_APP_USER_AUDIENCE=https://canton.network.global
      - AUTH_APP_USER_VALIDATOR_CLIENT_ID=app-user-validator
      - AUTH_APP_USER_VALIDATOR_CLIENT_SECRET=RdqUbFOBlz94eev4rS96dmG9lXPSHUfG
      - AUTH_APP_USER_VALIDATOR_USER_ID=c5d7778a-ce31-41e3-9c82-34f03e1fbb33
      # Base URLs for provider realm
      - AUTH_APP_PROVIDER_ISSUER_URL_BACKEND=http://nginx-keycloak:8082/realms/AppProvider
      - AUTH_APP_PROVIDER_WELLKNOWN_URL=http://nginx-keycloak:8082/realms/AppProvider/.well-known/openid-configuration
      - AUTH_APP_PROVIDER_JWK_SET_URL=http://nginx-keycloak:8082/realms/AppProvider/protocol/openid-connect/certs
      - AUTH_APP_PROVIDER_AUDIENCE=https://canton.network.global
      - AUTH_APP_PROVIDER_VALIDATOR_CLIENT_ID=app-provider-validator
      - AUTH_APP_PROVIDER_VALIDATOR_CLIENT_SECRET=pQagV9Fmy1S6HInFIAfUgUC9ZYG0btf0
      - AUTH_APP_PROVIDER_VALIDATOR_USER_ID=c87743ab-80e0-4b83-935a-4c0582226691
      # Expand party hints dynamically from PARTY_HINT
      - APP_USER_PARTY_HINT=app_user_${PARTY_HINT}
      - APP_PROVIDER_PARTY_HINT=app_provider_${PARTY_HINT}
      - SPLICE_APP_VALIDATOR_PARTICIPANT_ADDRESS=participant
      - SPLICE_APP_VALIDATOR_SV_SPONSOR_ADDRESS=${SPONSOR_SV_ADDRESS}
      - SPLICE_APP_VALIDATOR_SCAN_ADDRESS=${SCAN_ADDRESS}
      - SPLICE_APP_VALIDATOR_PARTICIPANT_IDENTIFIER=${PARTICIPANT_IDENTIFIER}
      - SPLICE_APP_VALIDATOR_WALLET_USER_NAME=${WALLET_ADMIN_USER}
      - SPLICE_APP_CONTACT_POINT=${CONTACT_POINT}
      - APP_USER_VALIDATOR_ONBOARDING_SECRET=${APP_USER_VALIDATOR_ONBOARDING_SECRET:-}
      - APP_PROVIDER_VALIDATOR_ONBOARDING_SECRET=${APP_PROVIDER_VALIDATOR_ONBOARDING_SECRET:-}
      - ONBOARDING_SECRET_URL=${ONBOARDING_SECRET_URL}
      - MIGRATION_ID=${MIGRATION_ID:-}
      - DB_SERVER=${SPLICE_DB_SERVER}
      - DB_PORT=${SPLICE_DB_PORT}
      - DB_USER=${SPLICE_DB_USER}
      - DB_PASSWORD=${SPLICE_DB_PASSWORD}
      - LEDGER_API_ADMIN_USER=${LEDGER_API_ADMIN_USER}
      - WALLET_ADMIN_USER=${WALLET_ADMIN_USER}
      - PARTY_HINT=${PARTY_HINT}
      - PARTICIPANT_IDENTIFIER=${PARTICIPANT_IDENTIFIER}
    volumes:
      - ./config/validator/app.conf:/app/app.conf
      - ./config/validator/bootstrap.sc:/app/bootstrap.sc
      - ./config/validator/entrypoint.sh:/splice-entrypoint.sh
      - ./config/validator/health-check.sh:/app/health-check.sh
      - domain-upgrade-dump:/domain-upgrade-dump
    entrypoint: /splice-entrypoint.sh
    ports:
      - "25003:25003"
      - "35003:35003"
    healthcheck:
      test: ["CMD", "bash", "/app/health-check.sh"]
      interval: 20s
      start_interval: 5s
      timeout: 40s
      retries: 100
      start_period: 30s
    depends_on:
      postgres-splice:
        condition: service_healthy
      nginx-keycloak:
        condition: service_started
      participant:
        condition: service_started
    restart: always
    networks:
      - dserv-network

  wallet-web-ui:
    image: "${IMAGE_REPO}wallet-web-ui:${IMAGE_TAG}"
    environment:
      - SPLICE_APP_UI_AUTH_AUDIENCE=${VALIDATOR_AUTH_AUDIENCE}
      - SPLICE_APP_UI_AUTH_CLIENT_ID=${WALLET_UI_CLIENT_ID}
      - SPLICE_APP_UI_AUTH_URL=${AUTH_URL}
      - SPLICE_APP_UI_HTTP_URL=true
      - SPLICE_APP_UI_NETWORK_NAME=${SPLICE_APP_UI_NETWORK_NAME}
      - SPLICE_APP_UI_NETWORK_FAVICON_URL=${SPLICE_APP_UI_NETWORK_FAVICON_URL}
      - SPLICE_APP_UI_AMULET_NAME=${SPLICE_APP_UI_AMULET_NAME}
      - SPLICE_APP_UI_AMULET_NAME_ACRONYM=${SPLICE_APP_UI_AMULET_NAME_ACRONYM}
      - SPLICE_APP_UI_NAME_SERVICE_NAME=${SPLICE_APP_UI_NAME_SERVICE_NAME}
      - SPLICE_APP_UI_NAME_SERVICE_NAME_ACRONYM=${SPLICE_APP_UI_NAME_SERVICE_NAME_ACRONYM}
    networks:
      - dserv-network

  nginx:
    image: "nginx:${NGINX_VERSION}"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    ports:
      - 80:80
    depends_on:
      - wallet-web-ui
      - validator
    restart: always
    healthcheck:
      test: ["CMD", "service", "nginx", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - dserv-network

  ###############################################################################################################
  ### Canton Console Services
  ###############################################################################################################
  canton-console-app-provider:
    image: "${IMAGE_REPO}canton:${IMAGE_TAG}"
    container_name: canton-console-app-provider
    mem_limit: 1gb
    volumes:
      - ./config/canton-console/app.conf:/app/app.conf
      - ./canton-console/entrypoint.sh:/app/entrypoint.sh
    environment:
      - _JAVA_OPTIONS=-XX:+UseContainerSupport -XX:-UseCompressedOops
      - PARTICIPANT_LEDGER_API_PORT=5001
      - PARTICIPANT_ADMIN_API_PORT=5002
      - LEDGER_API_ADDRESS=participant
      - CLIENT_ID=app-provider-validator
      - SECRET=${AUTH_APP_PROVIDER_VALIDATOR_CLIENT_SECRET}
      - TOKEN_URL=${AUTH_APP_PROVIDER_TOKEN_URL}
    env_file:
      - .env
    entrypoint: /app/entrypoint.sh
    stdin_open: true
    tty: true
    depends_on:
      participant:
        condition: service_started
      keycloak:
        condition: service_healthy
    networks:
      - dserv-network

  canton-console-app-user:
    image: "${IMAGE_REPO}canton:${IMAGE_TAG}"
    container_name: canton-console-app-user
    mem_limit: 1gb
    volumes:
      - ./config/canton-console/app.conf:/app/app.conf
      - ./canton-console/entrypoint.sh:/app/entrypoint.sh
    environment:
      - _JAVA_OPTIONS=-XX:+UseContainerSupport -XX:-UseCompressedOops
      - PARTICIPANT_LEDGER_API_PORT=5001
      - PARTICIPANT_ADMIN_API_PORT=5002
      - LEDGER_API_ADDRESS=participant
      - CLIENT_ID=app-user-validator
      - SECRET=${AUTH_APP_USER_VALIDATOR_CLIENT_SECRET}
      - TOKEN_URL=${AUTH_APP_USER_TOKEN_URL}
    env_file:
      - .env
    entrypoint: /app/entrypoint.sh
    stdin_open: true
    tty: true
    depends_on:
      participant:
        condition: service_started
      keycloak:
        condition: service_healthy
    networks:
      - dserv-network

  # pqs:
  #   image: ${SCRIBE_IMAGE}:${SCRIBE_VERSION}
  #   container_name: pqs
  #   working_dir: /daml3.3
  #   ports:
  #     - "9000:8080"
  #   env_file:
  #     - .env
  #     - ./env/ports.env
  #     - ./env/app-provider.env
  #     - ./env/pqs.env
  #   command:
  #     - "pipeline"
  #     - "ledger"
  #     - "postgres-document"
  #   depends_on:
  #     postgres-splice:
  #       condition: service_healthy
  #     participant:
  #       condition: service_healthy
  #     validator:
  #       condition: service_healthy
  #   restart: on-failure:100
  #   networks:
  #     - dserv-network
